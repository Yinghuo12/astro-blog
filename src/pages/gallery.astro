---
import MainGridLayout from '../layouts/MainGridLayout.astro'
import { getCollection } from 'astro:content'
import ImageWrapper from '@components/misc/ImageWrapper.astro'
import path from 'node:path'

// è·å–ç›¸å†Œé…ç½®æ–‡ä»¶
const galleryEntries = await getCollection('gallery')

// ä»æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­æå–ç…§ç‰‡ä¿¡æ¯
const allPhotos = galleryEntries.flatMap(entry => {
  const photos = entry.data.photos || []
  const basePath = path.join('content/gallery/', entry.slug.split('/').slice(0, -1).join('/'))
  return photos.map(photo => ({
    ...photo,
    _entryPath: basePath,
    _index: Math.random().toString(36).substr(2, 9) // å”¯ä¸€ID
  }))
})

// è¿‡æ»¤è‰ç¨¿
const visiblePhotos = allPhotos.filter(photo => !photo.draft)

// æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
const sortedPhotos = visiblePhotos.sort((a, b) => {
  const dateA = a.date || new Date(0)
  const dateB = b.date || new Date(0)
  return dateB.valueOf() - dateA.valueOf()
})

// æŒ‰ç›¸å†Œåˆ†ç»„
const photosByAlbum = sortedPhotos.reduce((acc, photo) => {
  const album = photo.album || 'default'
  if (!acc[album]) {
    acc[album] = []
  }
  acc[album].push(photo)
  return acc
}, {} as Record<string, typeof sortedPhotos>)

// è·å–æ‰€æœ‰ç›¸å†Œåç§°
const albums = Object.keys(photosByAlbum).sort()
---

<MainGridLayout title="ç›¸å†Œ" description="è®°å½•ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-8 relative w-full">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="flex items-center justify-between mb-8 pb-6 border-b border-[var(--border-color)]">
        <div>
          <h1 class="text-3xl font-bold text-[var(--primary)] mb-2">ğŸ“· ç›¸å†Œ</h1>
          <p class="text-black/60 dark:text-white/60">è®°å½•ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´</p>
        </div>
        <div class="text-sm text-black/50 dark:text-white/50">
          å…± {sortedPhotos.length} å¼ ç…§ç‰‡
        </div>
      </div>

      <!-- ç›¸å†Œåˆ—è¡¨ -->
      {albums.length > 0 ? (
        <div class="space-y-12">
          {albums.map(album => (
            <div class="album-section">
              <h2 class="text-2xl font-bold text-[var(--primary)] mb-6 flex items-center gap-3">
                <span class="text-3xl">ğŸ–¼ï¸</span>
                {album === 'default' ? 'æœªåˆ†ç±»' : album}
                <span class="text-sm font-normal text-black/50 dark:text-white/50">
                  ({photosByAlbum[album].length} å¼ )
                </span>
              </h2>

              <!-- ç…§ç‰‡ç½‘æ ¼ -->
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {photosByAlbum[album].map((photo) => {
                  return (
                    <div
                      class="gallery-photo group relative aspect-square overflow-hidden rounded-xl cursor-pointer hover:shadow-xl transition-all duration-300 hover:-translate-y-1"
                      data-title={photo.title || ''}
                      data-description={photo.description || ''}
                      data-date={photo.date ? photo.date.toLocaleDateString('zh-CN') : ''}
                      data-location={photo.location || ''}
                      data-album={photo.album || 'default'}
                      data-image={photo.image}
                    >
                      <ImageWrapper
                        src={photo.image}
                        basePath="content/gallery/images"
                        alt={photo.title || 'ç…§ç‰‡'}
                        class="w-full h-full object-cover"
                      />
                      <!-- æ‚¬åœé®ç½© -->
                      <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-300 flex items-center justify-center">
                        <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 text-white text-center p-4">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                          </svg>
                          <p class="text-sm font-medium">ç‚¹å‡»æŸ¥çœ‹å¤§å›¾</p>
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12 text-black/50 dark:text-white/50">
          <div class="text-4xl mb-4">ğŸ“·</div>
          <p>è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œè¯·åœ¨ content/gallery/images/ æ–‡ä»¶å¤¹ä¸‹æ·»åŠ ç…§ç‰‡ï¼Œå¹¶åœ¨ content/gallery/photos.md ä¸­é…ç½®ç…§ç‰‡ä¿¡æ¯</p>
        </div>
      )}
    </div>
  </div>
</MainGridLayout>
