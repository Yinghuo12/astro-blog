---
import MainGridLayout from '../../layouts/MainGridLayout.astro'
import { getCollection } from 'astro:content'
import Markdown from '@components/misc/Markdown.astro'
import TableOfContents from '@components/TableOfContents.svelte'

export async function getStaticPaths() {
  const diaries = await getCollection('diary')
  return diaries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }))
}

const { entry } = Astro.props
const { Content } = await entry.render()

// æ£€æŸ¥æ˜¯å¦ä¸ºç§å¯†æ—¥è®°
const isPrivate = entry.data.private || false
const password = entry.data.password || ''
const currentSlug = entry.slug
---

<!-- å¼•å…¥æ—¥è®°å¯†ç éªŒè¯è„šæœ¬ (ä»…ç§å¯†æ—¥è®°) -->
{isPrivate && <script src="/scripts/diary-password.js" is:inline></script>}


<MainGridLayout title={entry.data.title} description={entry.data.description}>
    <!-- å­˜å‚¨å¯†ç æ•°æ® -->
    {isPrivate && <span id="diary-config" data-password={password} data-slug={currentSlug} class="hidden"></span>}

    <div class="flex flex-col lg:flex-row gap-6 w-full">
        <!-- Main Content -->
        <div class="flex-1 min-w-0">
            <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
                <div class="card-base z-10 px-9 py-8 relative w-full">
                    <!-- æ—¥è®°å¤´éƒ¨ -->
                    <div class="mb-8 pb-6 border-b border-[var(--border-color)]">
                        <div class="flex items-center gap-2 text-sm text-black/50 dark:text-white/70 mb-3">
                            <span>ğŸ“… {entry.data.published.toLocaleDateString('zh-CN')}</span>
                            {entry.data.mood && <span>Â·</span>}
                            {entry.data.mood && <span>{entry.data.mood}</span>}
                            {isPrivate && <span>Â·</span>}
                            {isPrivate && <span class="text-[var(--primary)] dark:text-[var(--primary)] font-medium">ğŸ”’ ç§å¯†æ—¥è®°</span>}
                        </div>
                        <h1 class="text-3xl font-bold text-[var(--primary)] mb-3 flex items-center gap-2">
                            {entry.data.title}
                            {isPrivate && <span class="text-2xl">ğŸ”’</span>}
                        </h1>
                        {entry.data.tags && entry.data.tags.length > 0 && (
                            <div class="flex items-center gap-2">
                                {entry.data.tags.map(tag => (
                                    <span class="px-2 py-0.5 rounded-full bg-[var(--primary)]/10 text-[var(--primary)] text-xs">
                                        #{tag}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {isPrivate ? (
                        // <!-- ç§å¯†æ—¥è®°ï¼šæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢ -->
                        <>
                            <div id="diary-lock" class="flex flex-col items-center justify-center min-h-[40vh]">
                                <div class="text-6xl mb-6 animate-bounce">ğŸ”</div>
                                <h2 class="text-2xl font-bold text-[var(--primary)] mb-3">è¿™æ˜¯ä¸€ç¯‡ç§å¯†æ—¥è®°</h2>
                                <p class="text-black/70 dark:text-white/70 mb-8 text-center max-w-md">
                                    è¿™ç¯‡æ—¥è®°éœ€è¦å¯†ç æ‰èƒ½æŸ¥çœ‹<br/>è¯·è¾“å…¥å¯†ç ç»§ç»­é˜…è¯»
                                </p>
                                <div class="w-full max-w-md flex flex-col items-center">
                                    <div class="flex gap-3 w-full">
                                        <input
                                            type="password"
                                            id="diary-password"
                                            placeholder="è¾“å…¥å¯†ç ..."
                                            class="diary-password-input flex-1 px-5 py-3 rounded-xl border-2 border-[var(--border-color)] bg-transparent focus:outline-none focus:border-[var(--primary)] transition text-center text-lg tracking-widest text-90 dark:text-white/90 placeholder:text-black/40 dark:placeholder:text-white/40"
                                        />
                                        <button
                                            id="unlock-btn"
                                            class="px-6 py-3 rounded-xl bg-[var(--primary)] text-white font-bold hover:opacity-90 active:scale-95 transition"
                                        >
                                            è§£é”
                                        </button>
                                    </div>
                                    <p id="diary-error" class="text-red-500 dark:text-red-400 text-center w-full mt-4 hidden flex items-center justify-center gap-2">
                                        <span>âŒ</span>
                                        <span id="error-text">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</span>
                                    </p>
                                </div>
                            </div>

                            <!-- æ—¥è®°å†…å®¹ (è§£é”åæ˜¾ç¤º) -->
                            <div id="diary-content" class="hidden">
                                <Markdown class="markdown-content">
                                    <Content />
                                </Markdown>

                                <!-- è¿”å›æŒ‰é’® -->
                                <div class="mt-8 pt-6 border-t border-[var(--border-color)]">
                                    <a href="/diary-list/" class="btn-plain px-4 py-2 rounded-lg flex items-center gap-2 w-fit">
                                        <span>â†</span>
                                        <span>è¿”å›æ—¥è®°åˆ—è¡¨</span>
                                    </a>
                                </div>
                            </div>
                        </>
                    ) : (
                        // <!-- å…¬å¼€æ—¥è®°ï¼šç›´æ¥æ˜¾ç¤ºå†…å®¹ -->
                        <div id="diary-content">
                            <Markdown class="markdown-content">
                                <Content />
                            </Markdown>

                            <!-- è¿”å›æŒ‰é’® -->
                            <div class="mt-8 pt-6 border-t border-[var(--border-color)]">
                                <a href="/diary-list/" class="btn-plain px-4 py-2 rounded-lg flex items-center gap-2 w-fit">
                                    <span>â†</span>
                                    <span>è¿”å›æ—¥è®°åˆ—è¡¨</span>
                                </a>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    </div>

    <!-- Table of Contents (Desktop) -->
    {isPrivate ? (
        // ç§å¯†æ—¥è®°ï¼šä½¿ç”¨ client:visibleï¼Œåªæœ‰å½“å…ƒç´ å¯è§æ—¶æ‰æ°´åˆ
        <div id="toc-container-private" class="hidden" style="display: none;">
            <TableOfContents client:visible target=".markdown-content" />
        </div>
    ) : (
        // å…¬å¼€æ—¥è®°ï¼šç›´æ¥æ˜¾ç¤º
        <TableOfContents client:load target=".markdown-content" />
    )}
</MainGridLayout>

<style>
    .animate-bounce {
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    .animate-shake {
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }
        20%, 60% {
            transform: translateX(-10px);
        }
        40%, 80% {
            transform: translateX(10px);
        }
    }
</style>
